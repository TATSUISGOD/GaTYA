<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¬ãƒãƒ£ã‚²ãƒ¼ãƒ </title>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  background-color:#000;
  color:white;
  min-height:100vh;
}
.overlay{
  background:rgba(0,0,0,0.65);
  min-height:100vh;
  padding:20px;
}
button{
  padding:12px 24px;
  font-size:18px;
  cursor:pointer;
}
#result{
  font-size:30px;
  margin-top:15px;
  height:40px;
}

.shuffle{
  animation: flash 0.1s infinite;
}

@keyframes flash{
  0%{opacity:0.3}
  50%{opacity:1}
  100%{opacity:0.3}
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:15px;
}
.card{
  border:2px solid #666;
  padding:10px;
  text-align:center;
}
.card img{
  width:100%;
  height:120px;
  object-fit:cover;
  margin-top:5px;
}
.hidden{
  color:#555;
}
.rarity-Common{color:#ccc}
.rarity-Rare{color:#4aa3ff}
.rarity-Epic{color:#b65cff}
.rarity-Legendary{color:#ffb400}
.rarity-Mythic{color:#ff3c3c}
</style>
</head>

<body>
<div class="overlay">
  <h1>ğŸ² RNG èƒŒæ™¯ã‚¬ãƒãƒ£</h1>

  <button onclick="roll()">ãƒ­ãƒ¼ãƒ«</button>
  <p>å¤©äº•ï¼š<span id="count">0</span> / 300</p>
  <div id="result"></div>

  <hr>
  <h2>ğŸ“– å›³é‘‘</h2>
  <div class="grid" id="dex"></div>

  <hr>
  <h2>ğŸ“œ ãƒ­ãƒ¼ãƒ«å±¥æ­´</h2>
  <div id="log"></div>
</div>

<script>
const rarities = [
  {name:"Common", rate:60, rank:1, imgs:["images/common/c1.jpg","images/common/c2.jpg"]},
  {name:"Rare", rate:25, rank:2, imgs:["images/rare/r1.jpg","images/rare/r2.jpg"]},
  {name:"Epic", rate:10, rank:3, imgs:["images/epic/e1.jpg"]},
  {name:"Legendary", rate:4, rank:4, imgs:["images/legendary/l1.jpg"]},
  {name:"Mythic", rate:1, rank:5, imgs:["images/mythic/m1.jpg"]}
];

let data = JSON.parse(localStorage.getItem("rngFinalData")) || {
  count:0,
  owned:{},
  bgRank:0,
  bgImage:null,
  log:[]
};

function save(){
  localStorage.setItem("rngFinalData", JSON.stringify(data));
}

function roll(){
  data.count++;
  let result;

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ¼”å‡º
  let i = 0;
  const shuffle = setInterval(()=>{
    document.getElementById("result").className="shuffle";
    document.getElementById("result").textContent =
      rarities[i%rarities.length].name;
    i++;
  },100);

  setTimeout(()=>{
    clearInterval(shuffle);
    document.getElementById("result").className="";

    // å¤©äº•
    if(data.count >= 300){
      result = rarities[rarities.length-1];
      data.count = 0;
    }else{
      let r = Math.random()*100;
      let sum = 0;
      for(let ra of rarities){
        sum += ra.rate;
        if(r <= sum){
          result = ra;
          break;
        }
      }
    }

    const img = result.imgs[Math.floor(Math.random()*result.imgs.length)];

    data.owned[result.name] = (data.owned[result.name]||0)+1;
    data.log.unshift(result.name);
    if(data.log.length > 10) data.log.pop();

    document.getElementById("result").innerHTML =
      `<span class="rarity-${result.name}">${result.name}</span> ç¢ºå®šï¼`;

    if(result.rank > data.bgRank){
      if(result.rank >= 4){
        if(confirm("é«˜ãƒ¬ã‚¢èƒŒæ™¯ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ")){
          setBg(result,img);
        }
      }else{
        setBg(result,img);
      }
    }

    save();
    update();
  },1500);
}

function setBg(r,img){
  document.body.style.backgroundImage = `url('${img}')`;
  data.bgImage = img;
  data.bgRank = r.rank;
}

function update(){
  document.getElementById("count").textContent = data.count;

  document.getElementById("log").innerHTML =
    data.log.map(l=>`<div>${l}</div>`).join("");

  const dex = document.getElementById("dex");
  dex.innerHTML="";
  rarities.forEach(r=>{
    const owned = data.owned[r.name]||0;
    dex.innerHTML += `
      <div class="card">
        <div class="${owned?`rarity-${r.name}`:"hidden"}">
          ${owned ? r.name : "???"}
        </div>
        <div>æ‰€æŒï¼š${owned}</div>
        ${owned ? `<img src="${r.imgs[0]}">` : ""}
      </div>`;
  });

  if(data.bgImage){
    document.body.style.backgroundImage = `url('${data.bgImage}')`;
  }
}

update();
</script>
</body>
</html>
